# Clause Comparison Assistant

## 智能条款比对工具 使用说明书 v18.5

---

## 目录

1. [软件简介](#软件简介)
2. [文件依赖清单](#文件依赖清单)
3. [系统要求](#系统要求)
4. [安装与启动](#安装与启动)
5. [界面概览](#界面概览)
6. [基本操作流程](#基本操作流程)
7. [高级功能](#高级功能)
8. [v18.5 新功能](#v185-新功能)
9. [映射管理](#映射管理)
10. [比对报告说明](#比对报告说明)
11. [常见问题](#常见问题)
12. [技术支持](#技术支持)
13. [网页版详细说明](#网页版详细说明)
14. [算法原理](#算法原理)
15. [条款库格式详细说明](#条款库格式详细说明)
16. [故障排除指南](#故障排除指南)
17. [开发者文档](#开发者文档)
18. [附录](#附录)

---

## 软件简介

**Clause Comparison Assistant** 是一款专业的保险条款智能比对工具，采用多级匹配算法自动将客户条款清单与标准条款库进行匹配分析，生成详细的比对报告。

### 核心功能

| 功能 | 说明 |
|------|------|
| 智能匹配 | 多级匹配算法（精确匹配、语义匹配、关键词匹配、模糊匹配） |
| 匹配模式选择 | 支持自动检测、纯标题模式、完整内容模式（v18.3新增） |
| 多结果匹配 | 每条客户条款返回最多3条匹配供选择 |
| 条款查询 | 独立的条款库搜索功能，支持模糊搜索 |
| 除外条款过滤 | 智能过滤除外条款，避免误匹配 |
| 特殊规则匹配 | 内置特殊条款识别规则（如三停损失、责任免除修改等） |
| 用户映射优先 | 有自定义映射时优先使用，确保一致性 |
| 批量处理 | 支持同时处理多个客户文档 |
| 险种筛选 | 支持按险种Sheet筛选条款库 |
| 差异分析 | 自动识别条款内容差异并生成提示 |

### 技术特性

- **TF-IDF向量匹配**：快速候选筛选，提升匹配效率5-10倍
- **中文分词支持**：基于jieba分词，提高中文匹配准确率
- **双语条款处理**：智能分离中英混合条款进行匹配
- **动态权重调整**：根据标题和内容特征自动调整匹配权重
- **异步处理**：网页版支持异步批量处理，避免浏览器卡顿

---

## 文件依赖清单

### 核心文件（必需）

| 文件名 | 类型 | 说明 |
|--------|------|------|
| `Clause_Comparison_Assistant.py` | Python | 主程序（macOS桌面版） |
| `clause_mappings.json` | JSON | 条款映射数据存储文件 |
| `excluded_titles.json` | JSON | 排除词汇列表（v18.4+，不被识别为条款的标题） |
| `clause_toolkit_integrated.html` | HTML | 网页版工具（独立运行，无需Python环境） |

### 辅助模块

| 文件名 | 类型 | 说明 |
|--------|------|------|
| `clause_mapping_dialog.py` | Python | 映射管理对话框UI模块 |
| `clause_mapping_manager.py` | Python | 映射管理器逻辑模块 |

### 可选配置文件

| 文件名 | 类型 | 说明 |
|--------|------|------|
| `customer_config.json` | JSON | 客户自定义配置 |
| `customer_config.py` | Python | 配置管理模块 |
| `settings_page.py` | Python | 设置页面模块 |

### 其他版本

| 文件名 | 类型 | 说明 |
|--------|------|------|
| `Clause_Comparison_Assistant_windows.py` | Python | Windows版主程序 |

### 相关工具（独立使用）

| 文件名 | 类型 | 说明 |
|--------|------|------|
| `insurance_fee_processor.py` | Python | 保费费率处理器 |
| `multimodal_insurance_tool.py` | Python | 多模态保险工具（macOS版） |
| `multimodal_insurance_tool_windows.py` | Python | 多模态保险工具（Windows版） |
| `Combined_Tool_GUI_Pro_Cool.py` | Python | 综合工具GUI |

### 文件关系图

```
clause_comparison_package/
├── 核心程序
│   ├── Clause_Comparison_Assistant.py      ← 主程序入口
│   ├── clause_mapping_dialog.py            ← 被主程序导入
│   └── clause_mapping_manager.py           ← 被主程序导入
├── 数据文件
│   ├── clause_mappings.json                ← 运行时读写（用户映射）
│   └── excluded_titles.json                ← 排除词汇列表（v18.4+）
├── 配置文件（可选）
│   ├── customer_config.json
│   └── customer_config.py
├── 网页版（独立）
│   └── clause_toolkit_integrated.html      ← 独立运行，内嵌所有逻辑
└── 日志目录（自动生成）
    └── logs/
        └── Clause_Comparison_Assistant_YYYYMMDD.log
```

---

## 系统要求

### 桌面版（Python）

| 项目 | 要求 |
|------|------|
| 操作系统 | macOS 10.13+ / Windows 10+ |
| Python | 3.8 或更高版本 |
| 内存 | 建议 4GB 以上 |
| 磁盘空间 | 约 200MB |

**Python依赖库：**
```bash
pip install PyQt5 python-docx openpyxl pandas jieba
```

### 网页版（HTML）

| 项目 | 要求 |
|------|------|
| 浏览器 | Chrome 80+ / Safari 14+ / Edge 80+ / Firefox 75+ |
| 内存 | 建议 2GB 以上 |

网页版无需安装任何软件，直接用浏览器打开 `clause_toolkit_integrated.html` 即可使用。

---

## 安装与启动

### 方式一：桌面版（推荐）

**打包应用启动：**
1. 将 `ClauseNexus.app` 拖入「应用程序」文件夹
2. 首次运行时，如遇到"无法验证开发者"提示：
   - 打开「系统设置」→「隐私与安全性」
   - 找到相关提示，点击「仍要打开」按钮

**脚本启动：**
```bash
cd /path/to/clause_comparison_package
python3 Clause_Comparison_Assistant.py
```

### 方式二：网页版

直接用浏览器打开 `clause_toolkit_integrated.html` 文件即可。

---

## 界面概览

### 桌面版界面

```
┌──────────────────────────────────────────────────────────────────┐
│              🔍 智能条款比对工具                                   │
│     v18.3 · 匹配模式选择 · 多结果匹配 · 条款查询        💝 支持作者  │
│                  📊 配置统计信息                                  │
├──────────────────────────────────────────────────────────────────┤
│  📂 客户文档    [文件路径输入框]                          [选择]   │
│  📚 标准条款库  [文件路径输入框]                          [选择]   │
│  📋 险种Sheet   [下拉选择框]                                      │
│  ────────────────────────────────────────────────────────────── │
│  💾 保存路径    [文件路径输入框]                          [选择]   │
├──────────────────────────────────────────────────────────────────┤
│  匹配模式：[🔄 自动检测（推荐） ▼]                                 │  ← v18.3新增
├──────────────────────────────────────────────────────────────────┤
│  [🚀 开始比对] [📦 批量处理] [🔧 映射设置] [🔍 条款查询] [📂 打开目录] │
├──────────────────────────────────────────────────────────────────┤
│                          进度条                                   │
│                         日志输出区                                │
└──────────────────────────────────────────────────────────────────┘
```

### 网页版界面

网页版与桌面版功能完全一致，界面布局相同，支持：
- 拖拽文件上传
- 实时进度显示
- 映射管理（增删改查）
- 报告下载

### 界面风格

采用 Anthropic UI 设计风格：
- 温暖的奶油白背景 (#faf9f5)
- 浅米色卡片区域 (#f0eee6)
- 陶土色强调色 (#d97757)
- 清晰的视觉层次和舒适的阅读体验

---

## 基本操作流程

### 步骤一：选择客户文档

1. 点击「📂 客户文档」行的【选择】按钮
2. 选择客户提供的 Word 文档（.docx 格式）
3. 文档应包含条款清单，每个条款标题应独立成行

**客户文档格式要求：**

```
一、火灾险条款
   （条款内容...）

二、财产一切险条款
   （条款内容...）

三、Earthquake Extension Clause 地震扩展条款
   （双语条款会智能分离匹配...）

*纯条款名称+内容的的文档识别率更高   
```

### 步骤二：选择标准条款库

1. 点击「📚 标准条款库」行的【选择】按钮
2. 选择标准条款库 Excel 文件（.xlsx 格式）

**条款库格式要求：**

| 条款名称 | 产品注册号 | 条款内容 |
|---------|-----------|---------|
| 企业财产保险条款 | 备案号xxx | 条款全文... |
| 机器损坏险条款 | 备案号xxx | 条款全文... |

### 步骤三：选择险种Sheet（可选）

- 如果条款库包含多个Sheet（如财产险、责任险、工程险等）
- 从「📋 险种Sheet」下拉框选择对应的险种
- 选择正确的险种可减少误匹配，提高准确率

### 步骤四：选择匹配模式（v18.3新增）

从「匹配模式」下拉框选择：

| 模式 | 说明 | 适用场景 |
|------|------|---------|
| 🔄 自动检测（推荐） | 根据文档结构自动判断 | 大多数情况 |
| 📝 纯标题模式 | 只按条款标题匹配 | 文档只有条款名称，无正文 |
| 📄 完整内容模式 | 同时匹配标题和正文 | 需要精确内容匹配时 |

### 步骤五：设置保存路径

1. 点击「💾 保存路径」行的【选择】按钮
2. 选择报告保存位置和文件名
3. 默认保存为「条款比对报告.xlsx」

### 步骤六：开始比对

1. 点击【🚀 开始比对】按钮
2. 观察进度条和日志输出
3. 完成后会弹出提示

### 步骤七：查看报告

- 点击【📂 打开目录】按钮直接打开报告所在文件夹
- 或手动打开保存的 Excel 报告

---

## 高级功能

### 批量处理

适用于同时处理多个客户文档的场景。

1. 点击【📦 批量处理】按钮
2. 点击【添加文件】选择多个 Word 文档
3. 选择条款库和保存目录
4. 点击【开始批量处理】

每个文档会生成独立的比对报告，文件名格式为：`原文件名_比对报告.xlsx`

### 险种Sheet筛选

当条款库Excel包含多个Sheet时：

| Sheet名称 | 用途 |
|-----------|------|
| 财产险 | 企业财产险、家财险等条款 |
| 责任险 | 公众责任险、雇主责任险等 |
| 工程险 | 建工险、安工险等 |
| ... | ... |

### 特殊规则匹配

系统内置多条特殊匹配规则，自动识别特定条款：

| 客户条款关键词 | 自动匹配到 |
|--------------|-----------|
| 制造商/供应商担保 | 主条款相关约定 |
| 合同争议解决 | 主条款已有相关约定 |
| 责任免除第七条（七）修改 | 企业财产保险附加除外责任明晰条款 |
| 供应水、电、气 | 企业财产保险附加'三停'损失保险 |

### 套话内容过滤

系统自动过滤以下标准套话，避免影响匹配准确度：

- "本条款所述费用在本保险单明细表所列保险金额之外另行赔付。"
- "本附加险根据保险单的约定收取保险费。"
- "本保险单所载其他条件不变。"
- "本附加条款与主条款内容相悖之处，以本附加条款为准；未尽之处，以主条款为准。"

---

## v18.5 新功能

### 排除列表功能（v18.4+）

通过 `excluded_titles.json` 配置不应被识别为条款标题的内容。

**配置文件格式：**
```json
{
  "titles": [
    "EXCLUSIONS",
    "GENERAL PROVISION",
    "机器损坏保险条款",
    "财产一切险条款"
  ]
}
```

**优先级最高**：即使是 Heading 样式或包含"条款"关键词，在排除列表中的内容也不会被识别为标题。

### 已映射条款优先识别（v18.5）

在 `clause_mappings.json` 中已建立映射的客户条款名称，会被优先识别为标题。

**使用场景：**
- 条款名称不含"条款"、"Clause"等关键词
- 条款名称较短，不符合常规识别规则
- 例如：`Waiver of Excess`、`Extra Expense`、`Civil Authorities`

**操作方式：**
1. 先通过映射管理添加映射
2. 再次解析文档时，这些条款会被自动识别

### Heading 样式识别（v18.4+）

Word 文档中使用 Heading 1/2/3 样式的段落会被优先识别为条款标题。

**适用场景：**
- 条款名称不含关键词
- 文档作者已使用 Heading 样式标记条款

### 英文特殊条款关键词（v18.4+）

以下英文条款即使不含"Clause"、"Extension"等关键词，也会被正确识别：

| 关键词 | 说明 |
|-------|------|
| Burglary, Theft, Robbery | 盗窃抢劫 |
| Strike, Riot, Civil Commotion | 罢工暴动 |
| Malicious Damage, Terrorism | 恶意破坏/恐怖 |
| Flood, Earthquake, Typhoon | 自然灾害 |
| Automatic Reinstatement, Escalation | 自动恢复/递增 |
| Payment on Account | 预付款 |
| Waiver of Excess, Extra Expense | 免赔/额外费用 |
| Civil Authorities | 政府当局 |

### 条款识别优先级

```
1. ❌ 排除列表 (excluded_titles.json) - 最高优先级，一律跳过
2. ✅ is_likely_title 规则（条款/Clause等关键词）
3. ✅ 已映射条款名称（clause_mappings.json）
4. ✅ Heading 样式段落
5. ✅ 英文特殊条款关键词
```

### 从报告导入详细统计（v18.5）

从报告导入映射时，显示详细的导入统计：

```
导入完成！

• 新增: 15 条
• 更新: 3 条（覆盖已有映射）
• 相同: 42 条（已存在且相同）
• 跳过: 5 条（空值或无效）
```

### v18.3 功能回顾

**匹配模式选择：**

| 模式 | 效果 |
|------|------|
| 🔄 自动检测 | 系统根据文档结构自动判断 |
| 📝 纯标题模式 | 只按条款标题匹配 |
| 📄 完整内容模式 | 同时考虑标题和正文 |

**特殊长条款识别：**
```
兹经双方同意，责任免除第七条（七）修改为...
由于供应水、电、气及其他能源设备...
```

---

## 映射管理

### 什么是条款映射？

条款映射用于建立「客户条款名称」与「标准条款库名称」之间的对应关系。

**示例：**

| 客户名称 | 标准名称 |
|---------|---------|
| 72小时条款 | 企业财产保险附加时间调整（72小时）条款 |
| 罢工 | 企业财产保险附加罢工、暴动、民众骚乱条款 （2025版） |
| 恢复保险金额条款 | 企业财产保险附加自动恢复保险金额条款 |

### 打开映射管理

点击【🔧 映射设置】按钮，打开映射管理对话框。

### 添加单条映射

1. 在「客户条款名称」输入框输入客户使用的名称
2. 在「条款库名称」下拉框选择或输入标准名称
3. 点击【添加映射】

### 修改已有映射

在映射列表中点击【修改】按钮，可以编辑已保存的映射关系。

### 从报告导入映射

当您已经手动修正过比对报告中的匹配结果后，可以将修正后的映射关系导入系统。

**操作步骤：**

1. 点击【📥 从报告导入】按钮
2. 选择已修正的比对报告Excel文件
3. 查看导入统计，确认导入

**v18.5 导入统计（新功能）：**

导入完成后会显示详细统计：
- **新增**：新导入的映射数量
- **更新**：覆盖已有映射的数量
- **相同**：已存在且完全相同的数量（无需更新）
- **跳过**：空值或无效的条目数量

```
导入完成！

• 新增: 15 条
• 更新: 3 条
• 相同: 42 条（已存在且相同）
• 跳过: 5 条（空值或无效）
```

**自动清理功能：**

导入时会自动清理条款名称中的以下内容：
- 开头的编号（如 "1.", "8.", "10."）
- 限额信息（如 "（分项限额：总申报金额的10%）"）
- 金额信息（如 "（每次事故分项限额：人民币20,000,000元）"）

**示例：**

| 导入前 | 导入后 |
|-------|-------|
| 8. 企财险附加条款（限额：100万元） | 企财险附加条款 |
| 1. 火灾险条款（分项限额：总申报金额的25%） | 火灾险条款 |

### 导出与备份

- 点击【导出映射】可将当前映射导出为JSON文件
- 可用于备份或分享给其他用户

### 数据存储位置

映射数据保存在应用目录下：

```
[应用目录]/clause_mappings.json
```

---

## 比对报告说明

### 报告列说明

| 列名 | 说明 |
|------|------|
| 序号 | 条款序号 |
| 客户条款(原) | 客户文档中的原始条款名称 |
| 客户条款(译) | 翻译后的条款名称（如有英文条款） |
| 客户原始内容 | 客户文档中的条款内容 |
| 匹配条款库名称 | 匹配到的标准条款名称 |
| 产品注册号 | 标准条款的备案号 |
| 匹配条款库内容 | 标准条款的内容 |
| 综合匹配度 | 0-1之间的匹配分数 |
| 匹配级别 | 匹配类型（见下表） |
| 保障差异提示 | 条款内容差异分析 |
| 标题相似度 | 标题的匹配分数 |
| 内容相似度 | 内容的匹配分数 |

**多结果匹配列：**

| 列名 | 说明 |
|------|------|
| 匹配条款库名称2 | 第二候选匹配 |
| 综合匹配度2 | 第二候选分数 |
| 匹配条款库名称3 | 第三候选匹配 |
| 综合匹配度3 | 第三候选分数 |

### 匹配级别说明

| 级别 | 分数范围 | 含义 |
|------|---------|------|
| 精确匹配 | ≥98% | 条款名称高度一致 |
| 语义匹配 | 85%-98% | 条款含义相同，名称略有差异 |
| 关键词匹配 | 60%-85% | 包含相同关键词 |
| 模糊匹配 | 40%-60% | 可能相关，需人工确认 |
| 无匹配 | <40% | 未找到匹配条款 |

### 条件格式

报告自动应用颜色标识：

| 颜色 | 含义 |
|------|------|
| 🟢 绿色 | 精确匹配、语义匹配（≥85%） |
| 🟡 黄色 | 关键词匹配（60%-85%） |
| 🟠 橙色 | 模糊匹配（40%-60%） |
| 🔴 红色 | 无匹配（<40%） |

---

## 常见问题

### Q: 为什么有些条款无法匹配？

**可能原因：**
1. 客户使用了非标准的条款名称
2. 条款库中没有对应的条款
3. 条款名称差异过大
4. 选择了错误的险种Sheet
5. 匹配模式选择不当

**解决方案：**
- 使用「条款查询」功能先确认条款库中是否有该条款
- 使用「映射管理」添加自定义映射
- 选择正确的险种Sheet
- 尝试切换匹配模式（如从自动检测改为纯标题模式）

### Q: 如何提高匹配准确率？

1. **完善条款库**：确保条款库包含完整的条款信息
2. **选择正确险种**：使用Sheet筛选减少干扰
3. **积累映射**：将修正后的报告导入映射库
4. **利用多结果**：查看多个候选结果选择最准确的
5. **选择合适模式**：根据文档特点选择匹配模式

### Q: 多结果匹配什么时候显示？

- 当没有自定义映射时，系统返回最多3个候选结果
- 当有自定义映射时，只返回映射指定的1个结果
- 精确匹配时通常只有1个结果

### Q: 条款查询功能怎么用？

1. 首先需要选择并加载条款库文件
2. 然后点击【🔍 条款查询】按钮
3. 在弹出的对话框中输入关键词搜索

### Q: 纯标题模式和完整内容模式有什么区别？

| 模式 | 匹配依据 | 适用场景 |
|------|---------|---------|
| 纯标题模式 | 只看条款名称 | 文档只有条款列表，无详细正文 |
| 完整内容模式 | 同时看标题和正文 | 需要精确匹配条款内容时 |

### Q: 程序闪退或无响应？

1. 检查文件是否被其他程序占用
2. 确认文件格式正确（.docx 和 .xlsx）
3. 尝试重启应用程序
4. 查看日志文件排查问题
5. 网页版处理大文件时请耐心等待（有异步处理机制）

### Q: 如何更新条款库？

直接替换Excel文件即可，无需重新配置。建议保持列结构不变。

---

## 技术支持

### 日志位置

程序运行日志保存在：

```
[应用目录]/logs/Clause_Comparison_Assistant_YYYYMMDD.log
```

日志文件按日期自动分割，方便排查问题。

### 配置文件位置

```
[应用目录]/clause_mappings.json    # 条款映射数据
[应用目录]/customer_config.json    # 客户自定义配置（可选）
```

### 支持作者

如果这个工具对您的工作有帮助，欢迎点击界面上的【💝 支持作者】按钮。

---

## 网页版详细说明

### 功能对比

| 功能 | 桌面版 | 网页版 |
|------|--------|--------|
| 单文件比对 | ✅ | ✅ |
| 批量处理 | ✅ | ❌ |
| 映射管理 | ✅ | ✅ |
| 条款查询 | ✅ | ✅ |
| 险种Sheet选择 | ✅ | ✅ |
| 匹配模式选择 | ✅ | ✅ |
| 离线使用 | ✅ | ✅ |
| 无需安装 | ❌ | ✅ |

### 网页版特有功能

**拖拽上传：**
- 可直接将文件拖拽到对应区域
- 支持 .docx 和 .xlsx 文件

**数据存储：**
- 映射数据保存在浏览器 LocalStorage 中
- 清除浏览器缓存会丢失映射数据
- 建议定期导出映射备份

**报告下载：**
- 点击【📥 下载报告】按钮
- 自动生成并下载 Excel 文件
- 文件名格式：`条款比对报告_YYYYMMDD_HHMMSS.xlsx`

### 网页版使用限制

1. **文件大小**：建议单文件不超过 10MB
2. **条款数量**：建议单次比对不超过 500 条
3. **浏览器兼容**：推荐使用 Chrome 或 Edge

### 网页版故障排除

| 问题 | 解决方案 |
|------|---------|
| 页面无响应 | 刷新页面，等待异步处理完成 |
| 无法上传文件 | 检查文件格式，确保为 .docx/.xlsx |
| 映射丢失 | 从备份导入，或重新添加 |
| 报告下载失败 | 检查浏览器下载权限设置 |

---

## 算法原理

### 多级匹配流程

```
┌─────────────────────────────────────────────────────────────┐
│                     客户条款输入                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  第1级：用户映射查询                                          │
│  - 检查 clause_mappings.json 是否有精确映射                   │
│  - 有映射则直接返回，跳过后续匹配                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  第2级：特殊规则匹配                                          │
│  - 检查是否匹配内置特殊规则（如三停损失、责任免除修改等）         │
│  - 匹配则返回预设结果                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  第3级：精确匹配                                              │
│  - 标准化条款名称（去除空格、标点、统一全角半角）                │
│  - 在索引中查找完全一致的条款                                  │
│  - 匹配度 ≥ 98%                                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  第4级：语义匹配                                              │
│  - 使用 TF-IDF 向量计算相似度                                 │
│  - 结合标题相似度和内容相似度                                  │
│  - 匹配度 85% - 98%                                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  第5级：关键词匹配                                            │
│  - 提取条款关键词（险种、保障类型、特殊标识）                   │
│  - 在关键词索引中查找匹配                                      │
│  - 匹配度 60% - 85%                                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  第6级：模糊匹配                                              │
│  - 使用编辑距离算法                                           │
│  - 计算字符级别相似度                                         │
│  - 匹配度 40% - 60%                                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                     返回匹配结果（最多3条）                     │
└─────────────────────────────────────────────────────────────┘
```

### 核心算法说明

**1. 文本标准化**
```
输入: "企业  财产保险（综合险）条款"
输出: "企业财产保险综合险条款"

处理步骤:
- 去除多余空格
- 统一全角/半角字符
- 去除括号内说明文字（可配置）
- 统一同义词（如 "附加险" → "附加条款"）
```

**2. TF-IDF 向量匹配**
```
TF (词频) = 词在文档中出现次数 / 文档总词数
IDF (逆文档频率) = log(总文档数 / 包含该词的文档数)
TF-IDF = TF × IDF

相似度 = cos(向量A, 向量B)
```

**3. 中文分词**
```
使用 jieba 分词库进行中文分词
示例:
  输入: "企业财产保险附加地震条款"
  分词: ["企业", "财产", "保险", "附加", "地震", "条款"]
```

**4. 除外条款过滤**

系统自动识别并过滤除外责任条款，避免误匹配：
- 标题包含"除外"、"不保"、"免责"等关键词
- 内容以"本保险不承保"、"保险人不负责赔偿"开头

### 匹配权重配置

| 模式 | 标题权重 | 内容权重 |
|------|---------|---------|
| 纯标题模式 | 100% | 0% |
| 完整内容模式 | 60% | 40% |
| 自动检测 | 根据内容长度动态调整 |

---

## 条款库格式详细说明

### 基本格式

条款库必须是 Excel 文件（.xlsx 或 .xls），包含以下列：

| 列名 | 必需 | 说明 |
|------|------|------|
| 条款名称 | ✅ | 标准条款的正式名称 |
| 产品注册号 | ❌ | 条款的备案编号 |
| 条款内容 | ❌ | 条款的完整文本内容 |

### 列名识别规则

系统会自动识别以下列名变体：

| 标准列名 | 可识别的变体 |
|---------|-------------|
| 条款名称 | 名称、条款、产品名称、条款标题 |
| 产品注册号 | 注册号、备案号、编号、产品编号 |
| 条款内容 | 内容、条款文本、正文、详情 |

### 多Sheet支持

当条款库包含多个Sheet时：

```
条款库.xlsx
├── 财产险        (Sheet1)
├── 责任险        (Sheet2)
├── 工程险        (Sheet3)
└── 货运险        (Sheet4)
```

用户可在界面选择特定Sheet进行匹配，或选择"自动选择第一个Sheet"。

### 条款库优化建议

1. **统一命名规范**
   ```
   ✅ 推荐: 企业财产保险附加地震扩展条款
   ❌ 避免: 地震条款、EQ条款、地震险
   ```

2. **完善条款内容**
   - 内容越详细，语义匹配越准确
   - 建议包含条款全文，而非仅摘要

3. **分类管理**
   - 按险种分Sheet管理
   - 便于筛选和维护

4. **定期更新**
   - 及时添加新条款
   - 删除过期条款
   - 更新条款内容变更

### 示例条款库

```
| 条款名称                           | 产品注册号      | 条款内容                    |
|-----------------------------------|----------------|----------------------------|
| 企业财产保险条款                    | 备案号xxx-001  | 第一章 总则...              |
| 企业财产保险附加地震扩展条款         | 备案号xxx-002  | 兹经双方同意...              |
| 企业财产保险附加机器损坏险条款       | 备案号xxx-003  | 本保险承保...               |
| 企业财产保险附加'三停'损失保险       | 备案号xxx-004  | 由于供应水、电、气...         |
```

---

## 故障排除指南

### 启动问题

**问题：双击应用无反应**

| 检查项 | 解决方案 |
|-------|---------|
| macOS安全设置 | 系统设置 → 隐私与安全性 → 允许打开 |
| Python环境 | 确认已安装Python 3.8+ |
| 依赖库缺失 | 运行 `pip install -r requirements.txt` |

**问题：启动时报错 "No module named 'xxx'"**

```bash
# 安装缺失的依赖
pip install PyQt5 python-docx openpyxl pandas jieba

# 或使用国内镜像
pip install -i https://pypi.tuna.tsinghua.edu.cn/simple PyQt5 python-docx openpyxl pandas jieba
```

### 文件处理问题

**问题：无法读取Word文档**

| 原因 | 解决方案 |
|------|---------|
| 文件格式错误 | 确保是 .docx 格式（非 .doc） |
| 文件被占用 | 关闭Word程序后重试 |
| 文件损坏 | 用Word重新保存文件 |
| 权限不足 | 检查文件读取权限 |

**问题：无法读取Excel条款库**

| 原因 | 解决方案 |
|------|---------|
| 文件格式错误 | 确保是 .xlsx 格式（非 .xls） |
| Sheet为空 | 确认所选Sheet有数据 |
| 列名不匹配 | 检查是否有"条款名称"列 |
| 文件被占用 | 关闭Excel程序后重试 |

### 匹配问题

**问题：匹配准确率低**

```
诊断步骤:
1. 检查是否选择了正确的险种Sheet
2. 使用条款查询确认条款库中有对应条款
3. 检查客户条款名称是否有拼写错误
4. 尝试切换匹配模式
5. 添加自定义映射
```

**问题：条款未被识别**

可能原因：
- 条款格式不符合识别规则
- 条款过短（少于3个字符）
- 条款为纯数字或特殊符号

解决方案：
- 检查文档格式，确保条款标题独立成行
- 手动在映射中添加该条款

### 性能问题

**问题：处理速度慢**

| 原因 | 解决方案 |
|------|---------|
| 条款库过大 | 使用Sheet筛选减少条款数量 |
| 文档条款过多 | 分批处理 |
| 内存不足 | 关闭其他程序释放内存 |

**问题：程序卡死**

```
紧急处理:
1. 桌面版: 强制退出程序 (Cmd+Q / Alt+F4)
2. 网页版: 刷新页面
3. 查看日志文件定位问题
```

### 日志分析

日志文件位置：`[应用目录]/logs/Clause_Comparison_Assistant_YYYYMMDD.log`

常见日志信息：

| 日志级别 | 含义 |
|---------|------|
| INFO | 正常操作记录 |
| WARNING | 警告信息，不影响运行 |
| ERROR | 错误信息，可能影响功能 |

```
# 示例日志
2026-01-24 10:30:15 [INFO] 开始解析文档: example.docx
2026-01-24 10:30:16 [INFO] 提取到 50 条款
2026-01-24 10:30:17 [WARNING] 条款 "xxx" 未找到匹配
2026-01-24 10:30:20 [INFO] 比对完成，生成报告
```

---

## 开发者文档

### 代码结构

```
Clause_Comparison_Assistant.py
├── 导入与配置 (1-100行)
│   ├── 标准库导入
│   ├── 第三方库导入
│   └── 全局配置
├── 工具类 (100-500行)
│   ├── AnthropicColors - UI颜色定义
│   ├── TextCleaner - 文本清理工具
│   └── LibraryLoader - 条款库加载器
├── 核心逻辑 (500-2700行)
│   ├── ClauseMatcherLogic - 匹配逻辑核心
│   ├── MatchWorker - 单文件匹配线程
│   └── BatchMatchWorker - 批量匹配线程
├── UI组件 (2700-5700行)
│   ├── 对话框类
│   └── 自定义控件
└── 主窗口 (5700-6200行)
    ├── ClauseComparisonTab - 主界面
    └── main() - 入口函数
```

### 核心类说明

**ClauseMatcherLogic**
```python
class ClauseMatcherLogic:
    """条款匹配核心逻辑"""

    def parse_docx(self, path: str) -> Tuple[List[Dict], bool]:
        """解析Word文档，返回条款列表和是否为纯标题模式"""

    def build_index(self, lib_data: List[Dict]) -> Dict:
        """构建条款库索引"""

    def match_clause(self, clause: Dict, index: Dict, is_title_only: bool) -> Dict:
        """匹配单条条款"""

    def match_clause_multiple(self, clause: Dict, index: Dict, is_title_only: bool, max_results: int) -> List[Dict]:
        """匹配单条条款，返回多个结果"""
```

**ClauseMappingManager**
```python
class ClauseMappingManager:
    """条款映射管理器"""

    def load_mappings(self) -> Dict[str, str]:
        """加载映射数据"""

    def save_mapping(self, customer_name: str, lib_name: str) -> bool:
        """保存单条映射"""

    def delete_mapping(self, customer_name: str) -> bool:
        """删除映射"""

    def import_from_report(self, report_path: str) -> int:
        """从报告导入映射"""
```

### 扩展开发

**添加新的特殊规则**

在 `ClauseMatcherLogic` 类中的 `SPECIAL_RULES` 列表添加：

```python
SPECIAL_RULES = [
    {
        "patterns": ["关键词1", "关键词2"],
        "matched_name": "匹配到的条款名称",
        "message": "匹配提示信息",
        "match_level": "精确匹配",
    },
    # 添加更多规则...
]
```

**自定义匹配权重**

修改 `_calculate_combined_score` 方法：

```python
def _calculate_combined_score(self, title_score, content_score, is_title_only):
    if is_title_only:
        return title_score
    else:
        # 调整权重比例
        return title_score * 0.6 + content_score * 0.4
```

---

## 附录

### 附录A：快捷键

| 快捷键 | 功能 | 适用版本 |
|-------|------|---------|
| Cmd/Ctrl + O | 打开客户文档 | 桌面版 |
| Cmd/Ctrl + S | 保存报告 | 桌面版 |
| Cmd/Ctrl + Q | 退出程序 | 桌面版 |
| Enter | 开始比对 | 桌面版 |
| Esc | 关闭对话框 | 桌面版 |

### 附录B：术语表

| 术语 | 说明 |
|------|------|
| 条款库 | 包含标准条款信息的Excel数据库 |
| 映射 | 客户条款名称与标准条款名称的对应关系 |
| 精确匹配 | 条款名称完全一致或高度相似（≥98%） |
| 语义匹配 | 条款含义相同但名称有差异（85%-98%） |
| TF-IDF | 词频-逆文档频率，一种文本相似度算法 |
| 纯标题模式 | 只根据条款标题进行匹配 |
| 完整内容模式 | 同时考虑标题和正文进行匹配 |

### 附录C：支持的文件格式

| 类型 | 格式 | 说明 |
|------|------|------|
| 客户文档 | .docx | Microsoft Word 2007+ 格式 |
| 条款库 | .xlsx | Microsoft Excel 2007+ 格式 |
| 条款库 | .xls | Microsoft Excel 97-2003 格式 |
| 映射数据 | .json | JSON格式，用于导入导出 |
| 比对报告 | .xlsx | 自动生成的Excel报告 |

### 附录D：错误代码

| 错误代码 | 说明 | 解决方案 |
|---------|------|---------|
| E001 | 文件不存在 | 检查文件路径是否正确 |
| E002 | 文件格式不支持 | 转换为支持的格式 |
| E003 | 条款库为空 | 检查Excel文件内容 |
| E004 | 未找到条款名称列 | 添加"条款名称"列 |
| E005 | 内存不足 | 关闭其他程序或减少数据量 |

### 附录E：配置文件格式

**clause_mappings.json**（用户映射）
```json
{
  "72小时条款": "企业财产保险附加时间调整（72小时）条款",
  "罢工": "企业财产保险附加罢工、暴动、民众骚乱条款",
  "地震": "企业财产保险附加地震扩展条款"
}
```

**excluded_titles.json**（排除词汇列表，v18.4+）
```json
{
  "version": "1.0",
  "description": "排除词汇列表 - 这些词汇不会被识别为条款标题",
  "titles": [
    "EXCLUSIONS",
    "GENERAL PROVISION",
    "SCOPE OF COVER",
    "机器损坏保险条款",
    "财产一切险条款",
    "营业中断保险条款"
  ]
}
```

**customer_config.json**（可选）
```json
{
  "default_library_path": "/path/to/library.xlsx",
  "default_output_dir": "/path/to/output",
  "auto_save_mapping": true,
  "max_results": 3
}
```

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v18.5 | 2026-01-25 | 已映射条款优先识别、排除列表优先级修复、导入详细统计 |
| v18.4 | 2026-01-24 | 排除列表功能、Heading样式识别、英文特殊条款关键词 |
| v18.3 | 2026-01-24 | 匹配模式选择（自动/纯标题/完整内容） |
| v18.2 | 2026-01-23 | 特殊长条款识别、网页版异步处理优化 |
| v18.1 | 2026-01-22 | 特殊规则匹配（三停损失、责任免除修改等） |
| v17.1 | 2026-01-21 | 多结果匹配、条款查询、除外条款过滤 |
| v17.0 | 2026-01-20 | 中文分词、TF-IDF向量匹配、双语条款处理 |
| v16.1 | 2026-01-04 | 映射管理优化、批量导入功能 |
| v16.0 | 2025-12-23 | 索引加速、批量处理、Anthropic UI |

---

**Clause Comparison Assistant** - 让条款比对更智能

*Author: Dachi Yijin*
*Version: 18.5*
*Main Script: Clause_Comparison_Assistant.py*
*Web Version: clause_toolkit_integrated.html*
